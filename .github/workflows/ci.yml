name: Continuous Integration
on:
  # push:
  workflow_dispatch:
env:
  PRODUCT: 'WebGoat App'
  ENGAGEMENT: 'Test CD'
  TARGET: http://172.17.0.1:8081/WebGoat/

jobs:
  WAST:
    name: Web Application Security Testing
    runs-on: self-hosted
    permissions: read-all
    steps:
      - name: ls
        run: ls
      - name: run pentest
        uses: hoainamnv34/pentest@main
        with:
          target: '${{env.TARGET}}'  
          zap_http: ${{vars.ZAP_HTTP}}
          zap_https: ${{vars.ZAP_HTTP}}
      - name: ls
        run: ls
      - name: Upload Test results
        uses: actions/upload-artifact@v4
        with:
          name: wast-report
          path: ./report.xml
          
  import-WAST:
    needs: WAST
    name: Import WAST
    runs-on: self-hosted
    permissions: read-all
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: wast-report
          path: .
      - name: ls
        run: ls
      - name: import to DefectDojo
        uses: hoainamnv34/import-to-DefectDojo@main
        with:
          host: '${{vars.DEFECTDOJO_URL}}'
          product: ${{env.PRODUCT}}
          engagement: ${{env.ENGAGEMENT}}
          scan: 'ZAP Scan'
          is_new_import: 'True'
          report: 'report.xml'
          token:  ${{ secrets.DEFECT_DOJO_API_TOKEN }}
          active: "True"
          verified: "True"
          test_title: "Web Application Security Testing"
          close_old_findings: "True"
          close_old_findings_product_scope: "True"
          branch_tag: "${{ github.event.base_ref }}"
          commit_hash: "${{ github.sha }}"
  SAS:
    name: Security API Scanning
    runs-on: self-hosted
    permissions: read-all
    steps:
      - name: ls
        run: ls
      - name: run jmeter
        uses: hoainamnv34/jmeter@main
        with:
          target: '${{env.TARGET}}'  
          zap-host: ${{vars.ZAP_HTTP}}
      - name: ls
        run: ls
      - name: Upload Test results
        uses: actions/upload-artifact@v4
        with:
          name: sas-report
          path: ./report.xml
          
  import-SAS:
    needs: SAS
    name: Import SAS
    runs-on: self-hosted
    permissions: read-all
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: sas-report
          path: .
      - name: ls
        run: ls
      - name: import to DefectDojo
        uses: hoainamnv34/import-to-DefectDojo@main
        with:
          host: '${{vars.DEFECTDOJO_URL}}'
          product: ${{env.PRODUCT}}
          engagement: ${{env.ENGAGEMENT}}
          scan: 'ZAP Scan'
          is_new_import: 'True'
          report: 'report.xml'
          token:  ${{ secrets.DEFECT_DOJO_API_TOKEN }}
          active: "True"
          verified: "True"
          test_title: "Security API Scanning"
          close_old_findings: "True"
          close_old_findings_product_scope: "True"
          branch_tag: "${{ github.event.base_ref }}"
          commit_hash: "${{ github.sha }}"
          
  
